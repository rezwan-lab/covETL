# -*- coding: utf-8 -*-
"""Batch_Mutation_Analysis.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1VRWgUNZr2ep9RIAjGj9BYaQL-GSn-yCU

# **install_library**
"""

import pandas as pd
import numpy as np

"""# **data_upload**

mount_gdrive
"""

from google.colab import drive
drive.mount('/content/drive')

"""import_file"""

df = pd.read_table("/content/drive/MyDrive/Weekly_Analysis/WA28_07.10/nextstrain_metadata_WA28_07.10.tsv", sep='\t')

"""# **data_clean**"""

#dataNeed_Strain_Date_Division_Location_Submitting_Lab_Region_Type_Clade_Lineage_ImpLin_VariantStatus

#df.head(2)

"""delete_unnessary_columns_change_in_dataset"""

df.drop([ 'virus','gisaid_epi_isl', 'genbank_accession', 'region', 'country', 'region_exposure', 'country_exposure', 'division_exposure', 'segment', 'length', 'host', 'originating_lab', 'authors', 'url',
       'title', 'paper_url', 'date_submitted', 'purpose_of_sequencing', 'lab_id', 'totalInsertions', 'totalMissing', 'totalNonACGTNs', 'nonACGTNs', 'substitutions', 'deletions', 'aaDeletions', 'scorpio_call', 'note', 'pangoLEARN_version'], axis=1, inplace=True)
#df.head(2)

"""# Lineage_Name_Change"""

#focus on other

df.loc[df['lineage'] == 'B.1.1.7', 'ImpLin'] = 'Alpha'
df.loc[df['lineage'] == 'Q.1', 'ImpLin'] = 'Alpha'
df.loc[df['lineage'] == 'Q.2', 'ImpLin'] = 'Alpha'
df.loc[df['lineage'] == 'Q.3', 'ImpLin'] = 'Alpha'
df.loc[df['lineage'] == 'Q.4', 'ImpLin'] = 'Alpha'
df.loc[df['lineage'] == 'Q.5', 'ImpLin'] = 'Alpha'
df.loc[df['lineage'] == 'Q.6', 'ImpLin'] = 'Alpha'
df.loc[df['lineage'] == 'Q.7', 'ImpLin'] = 'Alpha'
df.loc[df['lineage'] == 'Q.8', 'ImpLin'] = 'Alpha'
df.loc[df['lineage'] == 'B.1.351', 'ImpLin'] = 'Beta'
df.loc[df['lineage'] == 'P.1', 'ImpLin'] = 'Gamma'
df.loc[df['lineage'] == 'B.1.525', 'ImpLin'] = 'Monitoring'
df.loc[df['lineage'] == 'B.1.526', 'ImpLin'] = 'Monitoring'
df.loc[df['lineage'] == 'B.1.617.1', 'ImpLin'] = 'Monitoring'
df.loc[df['lineage'] == 'C.37', 'ImpLin'] = 'Lambda'
df.loc[df['lineage'] == 'B.1.621', 'ImpLin'] = 'Mu'
df.loc[df['lineage'] == 'B.1.427', 'ImpLin'] = 'Monitoring'
df.loc[df['lineage'] == 'B.1.429', 'ImpLin'] = 'Monitoring'
df.loc[df['lineage'] == 'R.1', 'ImpLin'] = 'Monitoring'
df.loc[df['lineage'] == 'B.1.466.2', 'ImpLin'] = 'Monitoring'
df.loc[df['lineage'] == 'B.1.1.318', 'ImpLin'] = 'Monitoring'
df.loc[df['lineage'] == 'B.1.1.519', 'ImpLin'] = 'Monitoring'
df.loc[df['lineage'] == 'C.36.3', 'ImpLin'] = 'Monitoring'
df.loc[df['lineage'] == 'B.1.214.2', 'ImpLin'] = 'Monitoring'
df.loc[df['lineage'] == 'B.1.1.523', 'ImpLin'] = 'Monitoring'
df.loc[df['lineage'] == 'B.1.619', 'ImpLin'] = 'Monitoring'
df.loc[df['lineage'] == 'B.1.620', 'ImpLin'] = 'Monitoring'
df.loc[df['lineage'] == 'C.1.2', 'ImpLin'] = 'Monitoring'
df.loc[df['lineage'] == 'B.1.617.1', 'ImpLin'] = 'Monitoring'
df.loc[df['lineage'] == 'B.1.526', 'ImpLin'] = 'Monitoring'
df.loc[df['lineage'] == 'B.1.525', 'ImpLin'] = 'Monitoring'
df.loc[df['lineage'] == 'B.1.617.2', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.1', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.2', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.3', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.3.1', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.4', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.5', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.5.1', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.5.2', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.6', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.7', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.7.1', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.7.2', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.8', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.9', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.10', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.11', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.12', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.13', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.14', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.15', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.16', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.17', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.18', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.19', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.20', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.21', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.22', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.23', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.24', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.25', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.26', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.27', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.28', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.29', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.30', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.31', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.32', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.33', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.34', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.35', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.36', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.37', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'AY.38', 'ImpLin'] = 'Delta'
df.loc[df['lineage'] == 'None', 'ImpLin'] = 'None'
df.loc[(df['lineage'] != 'B.1.1.7') & (df['lineage'] != 'Q.1') & (df['lineage'] != 'Q.2') & (df['lineage'] != 'Q.3') & (df['lineage'] != 'Q.4') & (df['lineage'] != 'Q.5') & (df['lineage'] != 'Q.6') & (df['lineage'] != 'Q.7') & (df['lineage'] != 'Q.8') & (df['lineage'] != 'B.1.351') & (df['lineage'] != 'P.1') & (df['lineage'] != 'B.1.525') & (df['lineage'] != 'B.1.526') & (df['lineage'] != 'B.1.617.1') & (df['lineage'] != 'C.37') & (df['lineage'] != 'B.1.621') & (df['lineage'] != 'B.1.427') & (df['lineage'] != 'B.1.429') & (df['lineage'] != 'R.1') & (df['lineage'] != 'B.1.466.2') & (df['lineage'] != 'B.1.1.318') & (df['lineage'] != 'B.1.1.519') & (df['lineage'] != 'C.36.3') & (df['lineage'] != 'B.1.214.2') & (df['lineage'] != 'B.1.1.523') & (df['lineage'] != 'B.1.619') & (df['lineage'] != 'B.1.620') & (df['lineage'] != 'C.1.2') & (df['lineage'] != 'B.1.617.2') & (df['lineage'] != 'AY.1') & (df['lineage'] != 'AY.2') & (df['lineage'] != 'AY.3') & (df['lineage'] != 'AY.3.1') & (df['lineage'] != 'AY.4') & (df['lineage'] != 'AY.5') & (df['lineage'] != 'AY.5.1') & (df['lineage'] != 'AY.5.2') & (df['lineage'] != 'AY.6') & (df['lineage'] != 'AY.7') & (df['lineage'] != 'AY.7.1') & (df['lineage'] != 'AY.7.2') & (df['lineage'] != 'AY.8') & (df['lineage'] != 'AY.9') & (df['lineage'] != 'AY.10') & (df['lineage'] != 'AY.11') & (df['lineage'] != 'AY.12') & (df['lineage'] != 'AY.13') & (df['lineage'] != 'AY.14') & (df['lineage'] != 'AY.15') & (df['lineage'] != 'AY.16') & (df['lineage'] != 'AY.17') & (df['lineage'] != 'AY.18') & (df['lineage'] != 'AY.19') & (df['lineage'] != 'AY.20') & (df['lineage'] != 'AY.21') & (df['lineage'] != 'AY.22') & (df['lineage'] != 'AY.23') & (df['lineage'] != 'AY.24') & (df['lineage'] != 'AY.25') & (df['lineage'] != 'AY.26') & (df['lineage'] != 'AY.27') & (df['lineage'] != 'AY.28') & (df['lineage'] != 'AY.29') & (df['lineage'] != 'AY.30') & (df['lineage'] != 'AY.31') & (df['lineage'] != 'AY.32') & (df['lineage'] != 'AY.33') & (df['lineage'] != 'AY.34') & (df['lineage'] != 'AY.35') & (df['lineage'] != 'AY.36') & (df['lineage'] != 'AY.37') & (df['lineage'] != 'AY.38') & (df['lineage'] != 'None'), 'ImpLin'] = 'Other'

#variant_naming

df.loc[df['ImpLin'] == 'Alpha', 'Variant'] = 'VOC'
df.loc[df['ImpLin'] == 'Beta', 'Variant'] = 'VOC'
df.loc[df['ImpLin'] == 'Gamma', 'Variant'] = 'VOC'
df.loc[df['ImpLin'] == 'Delta', 'Variant'] = 'VOC'
df.loc[df['ImpLin'] == 'Lambda', 'Variant'] = 'VOI'
df.loc[df['ImpLin'] == 'Mu', 'Variant'] = 'VOI'
df.loc[df['ImpLin'] == 'Monitoring', 'Variant'] = 'Monitoring'
df.loc[(df['ImpLin'] != 'Alpha') & (df['ImpLin'] != 'Beta') & (df['ImpLin'] != 'Gamma') & (df['ImpLin'] != 'Delta') & (df['ImpLin'] != 'Lambda') & (df['ImpLin'] != 'Mu') & (df['ImpLin'] != 'Monitoring'), 'Variant'] = 'Other'

#df.head(2)

#date_format_change

df["date"] = pd.to_datetime(df["date"])
df["year"] = df["date"].dt.year
df["month"] = df["date"].dt.month
#df.head(2)

#amino_acid_explode

df['aaSubstitutions']=df['aaSubstitutions'].map(str)
df['aaSubstitutions'] = df['aaSubstitutions'].str.split(',')
mut1 = df.explode('aaSubstitutions')
mut1 = df.explode('aaSubstitutions')
mut1[['gene', 'aaMutations']] = mut1['aaSubstitutions'].str.split(':', expand=True)
#mut1.head(1)

#mutation_split

mut2 = mut1['aaMutations'].str.split('(\d+)([A-Za-z]+)', expand=True)
mut3 = pd.concat([mut1, mut2], axis=1, join='inner')
mut3.rename(columns={0:'RefAA', 1:'Position', 2:'AltAA'}, inplace=True)
mut3.drop(3, axis=1, inplace=True)
#mut3.head(2)

mut3["Position"] = pd.to_numeric(mut3["Position"])
mut3['count']=1

#mut3.head(2)

#mut3.to_csv('mutation_all_WA27.csv', index=False)

N=mut3[mut3['gene'] == 'N']

#N.head(2)

n2 = N[N['year'] == 2021]
options = ['6', '7', '8', '9', '10']
n3 = n2[n2['month'].isin(options)]

n3.to_csv('N_WA28_07.10.csv', index=False)

spike=mut3[mut3['gene'] == 'S']

#spike.head(2)

pd.options.mode.chained_assignment = None

spike.loc[spike['Position'] <= 15, 'Domian'] = 'S1'
spike.loc[(spike['Position'] >= 16) & (spike['Position'] <= 305) , 'Domian'] = 'NTD'
spike.loc[(spike['Position'] >= 306) & (spike['Position'] <= 329) , 'Domian'] = 'S1.1'
spike.loc[(spike['Position'] >= 330) & (spike['Position'] <= 521) , 'Domian'] = 'RBD'
spike.loc[(spike['Position'] >= 522) & (spike['Position'] <= 681) , 'Domian'] = 'S1/S2'
spike.loc[(spike['Position'] >= 682) & (spike['Position'] <= 814) , 'Domian'] = 'S2.1'
spike.loc[(spike['Position'] >= 815) & (spike['Position'] <= 833) , 'Domian'] = 'FP'
spike.loc[(spike['Position'] >= 834) & (spike['Position'] <= 911) , 'Domian'] = 'S2.2'
spike.loc[(spike['Position'] >= 912) & (spike['Position'] <= 985) , 'Domian'] = 'HR1'
spike.loc[(spike['Position'] >= 986) & (spike['Position'] <= 1035) , 'Domian'] = 'CH'
spike.loc[(spike['Position'] >= 1036) & (spike['Position'] <= 1075) , 'Domian'] = 'S2.3'
spike.loc[(spike['Position'] >= 1076) & (spike['Position'] <= 1141) , 'Domian'] = 'CD'
spike.loc[spike['Position'] > 1142, 'Domian'] = 'S2'

#spike.head(2)

#spike.to_csv('spike_WA27_06.10.csv', index=False)

s2 = spike[spike['year'] == 2021]

options = ['6', '7', '8', '9', '10']
s3 = s2[s2['month'].isin(options)]

s3.to_csv('spike_WA28_07.10.csv', index=False)